# Nginx示例

## 一、Nginx 是什么？

​		Nginx 是一个高性能的、开源的 **Web 服务器**软件，同时它也可以作为**反向代理**、**负载均衡器**、**邮件代理**和 **HTTP 缓存**。

​		它的核心特点是**高并发、高性能、低内存占用**，并且以**稳定性和丰富的功能集**而闻名。自 2004 年发布以来，Nginx 已成为全球最受欢迎的 Web 服务器之一，被许多高流量网站（如 GitHub、Netflix、Dropbox 等）所使用。



## 二、核心特点与优势

### 1 高并发与高性能（核心优势）

​		**事件驱动、异步非阻塞架构**：这是 Nginx 与传统 Web 服务器（如 Apache）最根本的区别。

- **Apache**： 多采用“每进程一连接”或“每线程一连接”的模型。当连接数暴涨时，会创建大量的进程/线程，消耗大量内存和 CPU 资源在上下文切换上，导致性能急剧下降。
- **Nginx**： 使用一个或几个工作进程，每个工作进程可以非阻塞地处理成千上万的网络连接。它通过一个事件循环（Event Loop）来监视所有连接，只有当某个连接有事件（比如可读或可写）发生时，才去处理它。这种模型非常高效，资源占用极少。

### 2 高扩展性

- **模块化设计**：Nginx 的功能由各种模块构成。核心代码只包含最基本的功能，其他如负载均衡、代理、SSL 加密等功能都由模块实现。这种设计使得 Nginx 非常灵活，可以根据需要定制。

**3、高可靠性** 

- **稳定性极佳**：Nginx 的进程模型非常健壮。主进程（Master Process）负责管理工作进程（Worker Processes）。即使某个工作进程意外终止，主进程也能立即启动一个新的工作进程，确保服务不中断。 
- **低内存消耗**：在处理海量并发连接时，Nginx 的内存增长非常平缓。



## 三、主要功能与应用场景

### 1 静态内容服务

​		这是 Nginx 最经典的角色。作为 Web 服务器，它处理静态资源（如 HTML、CSS、JavaScript、图片、视频）的效率极高，是 Apache 等其他服务器的数倍。

### 2 反向代理

​		这是 Nginx 在现代应用架构中最重要的角色。

**正向代理**：代理客户端，代表客户端访问外部服务器（如 VPN、科学上网工具）。

**反向代理**：代理服务器，代表后端服务器接收客户端的请求。 

**好处**： 

- **负载均衡**：将客户端请求分发到多个后端服务器，避免单点故障。

- **隐藏后端架构**：客户端只与反向代理交互，不知道后端服务器的真实信息，提升了安全性。

- **性能优化**：可以启用缓存，将常用内容缓存在 Nginx 端，直接返回给用户，减轻后端压力。

> **正向代理**是**我们（客户端）去找它**，让它帮我们拿东西。
>
> **反向代理**是**东西（服务）放在它后面**，它负责接收所有人的请求并分发给后面的服务。

### 3 负载均衡

​		Nginx 可以作为高效的负载均衡器，在多个后端应用服务器（如 Tomcat、Gunicorn、Node.js 等）之间分配流量。它支持多种分配策略：

- **轮询**：依次将请求发给每个服务器。
- **加权轮询**：根据服务器性能分配不同权重。

- **IP 哈希**：根据客户端 IP 将请求固定到某台服务器，可用于会话保持。

### 4 HTTP 缓存

​		可以配置 Nginx 将后端服务器的响应缓存起来。对于相同的请求，Nginx 可以直接返回缓存的结果，而无需再次访问后端服务器，极大提升了响应速度并降低了后端负载。

### 5 API 网关

​		在现代微服务架构中，Nginx 常被用作 API 网关的底层引擎，处理路由、认证、限流、日志记录等通用功能。



## 四、基本架构与工作原理

**主进程**：以 `root`权限运行，负责读取配置文件、绑定端口、管理工作进程。

**工作进程**：以非特权用户运行，负责实际处理客户端请求。它们是真正干活的进程。通常工作进程数量会设置为与服务器 CPU 核心数相同。

**事件驱动模型**：每个工作进程内部运行着一个高效的事件循环（如 `epoll`on Linux, `kqueue`on BSD），可以同时监控数千个连接。当连接准备好进行读取或写入时，工作进程才会去处理它，而不是阻塞等待。

**一个简单的比喻**：

- **Apache（多线程模型）**像一个餐厅，每来一个客人（请求）就派一个服务员（线程）全程服务。客人多了，服务员就不够用了。
- **Nginx（事件驱动模型）**像一个高级餐厅的接待员（工作进程）。他站在门口，手里有一个呼叫器列表（事件循环）。当某桌客人需要点菜（可读事件）或某桌的菜做好了需要上菜（可写事件）时，呼叫器会响，接待员才过去处理一下，然后马上回来继续待命。一个人可以同时照看整个餐厅。



## 五、核心配置文件简介

Nginx 的配置集中在 `nginx.conf`文件中，结构清晰，采用指令块的形式：

```nginx
# 主上下文，配置影响全局的指令
user nginx;          # 运行工作进程的用户和组
worker_processes auto; # 工作进程数，通常设为CPU核心数

events {
    # 配置事件模型和连接数
    worker_connections 1024; # 每个工作进程的最大连接数
}

http {
    # HTTP 服务器相关配置

    # 上游服务器组，用于反向代理和负载均衡
    upstream backend_servers {
        server 10.0.1.10:8080 weight=3; # 权重为3
        server 10.0.1.20:8080;          # 权重默认为1
    }

    # 定义一个虚拟主机
    server {
        listen 80;          # 监听80端口
        server_name example.com; # 域名

        # 定义一个位置块，用于匹配URL
        location / {
            # 将请求代理到上游服务器组
            proxy_pass http://backend_servers;
        }

        # 服务静态文件
        location /static/ {
            # 将URL中`/static/`映射到服务器的`/data/www/static`目录
            alias /data/www/static/;
        }
    }
}
```











