# WebSocket示例

## 一、概述

### 1 简介

​		**WebSocket**是一种在单个 TCP 连接上进行**全双工通信**的网络协议。

​		它的主要目的是解决 HTTP 协议在**实时性**和**双向通信**上的不足。它允许服务端主动向客户端推送数据，使得客户端和服务器之间的数据交换变得更加简单和高效。

**一个简单的比喻：**

- **HTTP**：像 **对讲机**。你按一下说话（发送请求），对方回答（返回响应），然后结束。每次通信都要重新建立连接。
- **WebSocket**：像 **打电话**。电话接通后（建立连接），双方可以随时、自由地对话，连接一直保持，直到一方挂断。



### 2 目的

​		在 WebSocket 出现之前，实现实时通信（如网页聊天、实时股价、在线游戏）非常麻烦，通常采用以下“黑客”手段：

1. **轮询**：客户端每隔几秒就向服务器发一个 HTTP 请求问：“有新数据吗？” 不管有没有新数据，服务器都立即响应。这种方式浪费了大量带宽和服务器资源。
2. **长轮询**：客户端发起一个请求，如果服务器没有新数据，就把这个请求挂起，直到有数据或超时才返回。客户端收到响应后立即再发起一个新的请求。虽然比短轮询好一些，但依然复杂且可能超时。

**这些方法的问题：**

- **效率低下**：HTTP 头部信息庞大，每次通信都要携带完整的头信息。
- **实时性差**：总有延迟，无法做到真正的即时。

- **开发复杂**：逻辑繁琐，需要维护请求状态。

**WebSocket 完美地解决了这些问题。**



### 3 核心特点

| 特性            | 描述                                                         |
| --------------- | ------------------------------------------------------------ |
| **全双工通信**  | 建立连接后，客户端和服务器可以**同时**向对方发送数据。       |
| **单一TCP连接** | 整个会话周期内只使用一个持久的 TCP 连接，避免了 HTTP 的频繁连接开销。 |
| **低开销**      | 建立连接后，数据传输的报文头很小（通常只有 2-10 字节），远小于 HTTP 头。 |
| **实时性**      | 服务器可以主动向客户端推送数据，实现真正的实时通信。         |
| **协议切换**    | 通过 HTTP/1.1 的 `Upgrade`机制来建立 WebSocket 连接，兼容现有基础设施（如 80/443 端口）。 |



### 4 工作原理：连接建立与通信

​		WebSocket 连接的建立依赖于 HTTP，但之后的通信就完全独立了。

**1、握手阶段（基于 HTTP）**

​		客户端首先发送一个特殊的 HTTP 请求，请求“升级”到 WebSocket 协议。

**2、数据传输阶段**

​		握手成功后，TCP 连接保持打开，客户端和服务器开始使用 WebSocket 协议定义的数据帧进行双向通信。

​		WebSocket 协议将数据封装成**帧**，帧的格式非常精简，包含操作码（区分文本/二进制数据）、掩码（客户端到服务器需要）、载荷长度和实际数据载荷。

​		**对于应用开发者而言**（比如使用浏览器的 JavaScript API），我们无需关心底层的帧格式，直接使用简单的 API 发送和接收消息即可。



### 5 应用场景

WebSocket 特别适合需要**高实时性**和**服务器主动推送**的场景：

1. **实时聊天应用**：网页版微信、QQ、钉钉等。
2. **多人在线游戏**：网页游戏中的实时对战、状态同步。
3. **实时数据展示**：股票行情、体育赛事直播、实时监控大屏。
4. **在线协作工具**：如 Google Docs，多人同时编辑一个文档，实时看到对方的修改。
5. **即时通知**：社交媒体的点赞、评论通知。



## 二、其他

### 1 单工、半双工、全双工

**1、单工**

- **定义**：数据只能在一个方向上流动。
- **比喻**：**广播电台**。电台只能发送信号，你的收音机只能接收信号，无法反向发送。

- **技术实例**：传统的电视广播、FM/AM收音机。

**2、半双工**

- **定义**：数据可以双向流动，但**不能同时进行**。在某一时刻，只能有一方发送，另一方接收。
- **比喻**：**对讲机**。你按下通话键说话时，无法听到对方的声音；松开按键听对方说话时，自己无法发送。

- **技术实例**：早期的集线器组成的网络、Wi-Fi（在某种程度上是半双工的，因为同一时刻共享信道）、传统的双向无线电。

**3、全双工**

- **定义**：数据可以**同时**在两个方向上流动。
- **比喻**：**电话通话**。双方可以同时说和听，交流非常自然、高效。
- **技术实例**：**现代电话网络、WebSocket、TCP连接、现代的交换机网络**。



### 2 全双工的实例

**1、TCP 协议是全双工的**

这是理解很多高级协议的基础。当一个 TCP 连接建立后：

- 连接的两端（客户端和服务器）都各自维护着一个**发送缓冲区**和**接收缓冲区**。
- 应用程序可以**同时**调用 `send()`方法发送数据和处理 `receive()`方法接收到的数据。

- 数据在两个方向上的传输是完全独立的。一端可以发送一个很长的文件，同时接收另一端发来的即时消息。

**2、WebSocket 是全双工的**

WebSocket 是基于 TCP 的应用层协议，它自然继承了 TCP 的全双工特性。

- **建立连接后**，服务器可以**在任何时候**主动向客户端推送消息，而客户端也**可以在任何时候**向服务器发送消息。
- 这种能力使其成为实现**实时应用**（如聊天室、在线协作编辑、股票行情）的理想选择。





