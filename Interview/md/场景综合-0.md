# 场景综合-0

## 1 SpringCloud在本地自测

**方式一：Zuul**

spring-boot 的 1.5.10.RELEASE 版本：

```
客户端（手机、PC）
    ↓
[ Ngix ] ←→ 反向代理
    ↓
[ Zuul API Gateway ] ←→ 网关：负载均衡、路由、过滤
    ↓
[  Eureka Server  ] ←→ 服务注册中心：服务发现
    ↑        ↑
A-admin     A-admin    ←→ 微服务实例
(注册)       (注册)
    ↑         ↑
B-service ←→ B-service    ←→ service站点相互调用
(注册)       (注册)
```

**原理：**

​		**Ribbon 是 Zuul 的负载均衡引擎**。Zuul 依赖 Ribbon 来实现服务的负载均衡调用。 

```
客户端请求
    ↓
[  Zuul Gateway  ] ← 接收请求
    ↓
路由匹配 → 找到目标服务
    ↓
[  Ribbon 负载均衡  ] ← 从 Eureka 获取服务列表
    ↓
选择具体服务实例
    ↓
转发请求
```

**实现方法：**

A-admin：

```yml
#  拒绝从eureka中获取实例
ribbon.eureka.enabled = false
# 指定 zuul 网关服务
zuul-service.ribbon.listOfServers = http://127.0.0.1:9000
```

Zuul：

​		不向集群的eureka注册，只向eureka中获取其他站点的接口信息，避免影响其他集群项目的站点使用本地启动的zuul。

​		将zuul路由指向成本地的启动的站点。

```yml
eureka:
  client:
    serviceUrl:
      defaultZone: http://{集群中的IP:port}/eureka/
    register-with-eureka: false	# 是否向eureka注册

zuul:
  routes:
    A-service:
      path: /A-service/**
      url: http://127.0.0.1:9001	# 本地启动的A-service
    B-service:
      path: /B-service/**
      url: http://127.0.0.1:9002	# 本地启动的B-service
```

Host：

​		配置host使得域名指向本地IP。admin项目使用默认端口80启动。

```bash
127.0.0.1	a.test.com
```



**方式二：微服务站点直连**

spring-boot 的 2.3.12.RELEASE 版本：

原理：**Ribbon 的静态服务列表配置**

```
┌─────────────┐    1. 读取配置     ┌─────────────┐
│             │◄──────────────────│             │
│  Ribbon     │                   │ application │
│  Client     │                   │   .yml      │
│             │                   │             │
└──────┬──────┘                   └─────────────┘
       │
       │ 2. 创建 ConfigurationBasedServerList
       │
┌──────▼──────┐    3. 获取服务列表 ┌─────────────┐
│ ServerList  │───────────────────►│  配置中的    │
│  Interface  │                   │ listOfServers│
└──────┬──────┘                   └─────────────┘
       │
       │ 4. 返回服务实例列表
       │
┌──────▼──────┐
│ LoadBalancer│
│             │
└──────┬──────┘
       │
       │ 5. 选择服务实例
       │
┌──────▼──────┐
│  发起HTTP    │
│   请求      │
└─────────────┘
```

**实现方法：**

A-admin（单个service）

```yml
# A-admin 指向 本地的home-service
home-service:
  ribbon:
    listOfServers: http://localhost:9005
    NIWSServerListClassName: com.netflix.loadbalancer.ConfigurationBasedServerList
```

> 各个部分的作用：
>
> **`listOfServers`**：
>
> - 指定服务的实例地址列表
> - 格式：`host:port,host2:port2`
> - 多个地址用逗号分隔
>
> - 这是**硬编码的服务地址**，不依赖服务注册中心
>
> **`NIWSServerListClassName`**：
>
> - 指定 Ribbon 使用的服务列表实现类
> - `ConfigurationBasedServerList`表示从配置文件读取服务列表
> - 这是 Netflix Internal Web Service Server List 的缩写

A-admin（多个服务实例）

```yml
home-service:
  ribbon:
    # 多个实例，Ribbon会自动轮询
    listOfServers: http://localhost:9005,http://localhost:9006,http://localhost:9007
    NIWSServerListClassName: com.netflix.loadbalancer.ConfigurationBasedServerList
    # 负载均衡策略
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule
```



